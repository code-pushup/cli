name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NX_NON_NATIVE_HASHER: true
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Linter Old Eslint Version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - name: Set base and head for Nx affected commands
        uses: nrwl/nx-set-shas@v4
      - name: Install dependencies
        run: npm ci
      - name: Lint affected projects with default settings and old eslint version
        run: npx nx run-many -t lint --skipNxCache --parallel=1

  lint-concurrency-off:
    runs-on: ubuntu-latest
    name: Linter with multithreading feature set to off
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - name: Set base and head for Nx affected commands
        uses: nrwl/nx-set-shas@v4
      - name: Install dependencies
        run: npm ci
      - name: Lint affected projects with concurrency off
        run: npx nx run-many -t lint-multi --concurrency off --skipNxCache --parallel=1

  lint-concurrency-auto:
    runs-on: ubuntu-latest
    name: Linter with multithreading feature set to auto
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - name: Set base and head for Nx affected commands
        uses: nrwl/nx-set-shas@v4
      - name: Install dependencies
        run: npm ci
      - name: Lint affected projects with concurrency auto
        run: npx nx run-many -t lint-multi --concurrency auto --skipNxCache --parallel=1

    lint-concurrency-1:
      runs-on: ubuntu-latest
      name: Linter with multithreading feature set to 1
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version-file: .nvmrc
            cache: npm
        - name: Set base and head for Nx affected commands
          uses: nrwl/nx-set-shas@v4
        - name: Install dependencies
          run: npm ci
        - name: Lint affected projects with concurrency 1
          run: npx nx run-many -t lint-multi --concurrency 1 --skipNxCache --parallel=1

    lint-concurrency-2:
      runs-on: ubuntu-latest
      name: Linter with multithreading feature set to 2
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version-file: .nvmrc
            cache: npm
        - name: Set base and head for Nx affected commands
          uses: nrwl/nx-set-shas@v4
        - name: Install dependencies
          run: npm ci
        - name: Lint affected projects with concurrency 2
          run: npx nx run-many -t lint-multi --concurrency 2 --skipNxCache --parallel=1

    lint-concurrency-3:
      runs-on: ubuntu-latest
      name: Linter with multithreading feature set to 3
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version-file: .nvmrc
            cache: npm
        - name: Set base and head for Nx affected commands
          uses: nrwl/nx-set-shas@v4
        - name: Install dependencies
          run: npm ci
        - name: Lint affected projects with concurrency 3
          run: npx nx run-many -t lint-multi --concurrency 3 --skipNxCache --parallel=1

      lint-concurrency-4:
        runs-on: ubuntu-latest
        name: Linter with multithreading feature set to 4
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
            with:
              fetch-depth: 0
          - name: Set up Node.js
            uses: actions/setup-node@v4
            with:
              node-version-file: .nvmrc
              cache: npm
          - name: Set base and head for Nx affected commands
            uses: nrwl/nx-set-shas@v4
          - name: Install dependencies
            run: npm ci
          - name: Lint affected projects with concurrency 4
            run: npx nx run-many -t lint-multi --concurrency 4 --skipNxCache --parallel=1

      lint-concurrency-5:
        runs-on: ubuntu-latest
        name: Linter with multithreading feature set to 5
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
            with:
              fetch-depth: 0
          - name: Set up Node.js
            uses: actions/setup-node@v4
            with:
              node-version-file: .nvmrc
              cache: npm
          - name: Set base and head for Nx affected commands
            uses: nrwl/nx-set-shas@v4
          - name: Install dependencies
            run: npm ci
          - name: Lint affected projects with concurrency 5
            run: npx nx run-many -t lint-multi --concurrency 5 --skipNxCache --parallel=1

        lint-concurrency-6:
          runs-on: ubuntu-latest
          name: Linter with multithreading feature set to 6
          steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                fetch-depth: 0
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                node-version-file: .nvmrc
                cache: npm
            - name: Set base and head for Nx affected commands
              uses: nrwl/nx-set-shas@v4
            - name: Install dependencies
              run: npm ci
            - name: Lint affected projects with concurrency 6
              run: npx nx run-many -t lint-multi --concurrency 6 --skipNxCache --parallel=1
