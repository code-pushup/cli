# @code-pushup/lighthouse-plugin

[![npm](https://img.shields.io/npm/v/%40code-pushup%2Flighthouse-plugin.svg)](https://www.npmjs.com/package/@code-pushup/lighthouse-plugin)
[![downloads](https://img.shields.io/npm/dm/%40code-pushup%2Flighthouse-plugin)](https://npmtrends.com/@code-pushup/lighthouse-plugin)
[![dependencies](https://img.shields.io/librariesio/release/npm/%40code-pushup/lighthouse-plugin)](https://www.npmjs.com/package/@code-pushup/lighthouse-plugin?activeTab=dependencies)

üïµÔ∏è **Code PushUp plugin for measuring web performance and quality with Lighthouse.** üî•

---

The plugin parses your lighthouse configuration and lints all audits of the official [lighthouse](https://github.com/GoogleChrome/lighthouse/blob/main/readme.md#lighthouse-------) CLI.

Detected lighthouse audits are mapped to Code PushUp audits. Audit reports are calculated based on the [original implementation](https://googlechrome.github.io/lighthouse/scorecalc/).

For more infos visit the [official docs](https://developer.chrome.com/docs/lighthouse/overview).

## Getting started

1. If you haven't already, install [@code-pushup/cli](../cli/README.md) and create a configuration file.

2. Install as a dev dependency with your package manager:

   ```sh
   npm install --save-dev @code-pushup/lighthouse-plugin
   ```

   ```sh
   yarn add --dev @code-pushup/lighthouse-plugin
   ```

   ```sh
   pnpm add --save-dev @code-pushup/lighthouse-plugin
   ```

3. Add this plugin to the `plugins` array in your Code PushUp CLI config file (e.g. `code-pushup.config.ts`).

   Pass in the path to your ESLint config file, along with glob patterns for which files you wish to target (relative to `process.cwd()`).

   ```ts
   import lighthousePlugin from '@code-pushup/lighthouse-plugin';

   export default {
     // ...
     plugins: [
       // ...
       await lighthousePlugin('https://example.com'),
     ],
   };
   ```

4. Run the CLI with `npx code-pushup collect` and view or upload report (refer to [CLI docs](../cli/README.md)).

### Optionally set up categories

@TODO

## Flags

The plugin accepts a second optional argument, `flags`.

`flags` is the lighthouse [CLI flags](https://github.com/GoogleChrome/lighthouse/blob/7d80178c37a1b600ea8f092fc0b098029799a659/cli/cli-flags.js#L80) as a JS object.

Within the flags object a couple of other external configuration files can be referenced. e.g. `configPath` , `preset` or `budgetPath` reference external `json` or JavaScript files.

| Category      | Argument                          | Description                                                                                                                                                                                                                                                                                                                                                                                                                      | Type      | Default     |
| ------------- | --------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- | ----------- |
| Logging       | verbose                           | Displays verbose logging.                                                                                                                                                                                                                                                                                                                                                                                                        | `boolean` | `false`     |
|               | quiet                             | Displays no progress, debug logs, or errors.                                                                                                                                                                                                                                                                                                                                                                                     | `boolean` | `false`     |
| Configuration | save-assets                       | Save the trace contents & devtools logs to disk.                                                                                                                                                                                                                                                                                                                                                                                 | `boolean` | `false`     |
|               | additional-trace-categories       | Additional categories to capture with the trace (comma-delimited).                                                                                                                                                                                                                                                                                                                                                               | `string`  |             |
|               | config-path                       | The path to the config JSON. An example config file: core/config/lr-desktop-config.js                                                                                                                                                                                                                                                                                                                                            | `string`  |             |
|               | preset                            | Use a built-in configuration. WARNING: If the `config-path` flag is provided, this preset will be ignored.                                                                                                                                                                                                                                                                                                                       | `string`  |             |
|               | chrome-flags                      | Custom flags to pass to Chrome (space-delimited). For a full list of flags, see [chrome-flags-list](https://peter.sh/experiments/chromium-command-line-switches/). Additionally, use the CHROME_PATH environment variable to use a specific Chrome binary. Requires Chromium version 66.0 or later. If omitted, any detected Chrome Canary or Chrome stable will be used.                                                        | `string`  | ''          |
|               | port                              | The port to use for the debugging protocol. Use 0 for a random port.                                                                                                                                                                                                                                                                                                                                                             | `number`  | 0           |
|               | hostname                          | The hostname to use for the debugging protocol.                                                                                                                                                                                                                                                                                                                                                                                  | `string`  | '127.0.0.1' |
|               | form-factor                       | Determines how performance metrics are scored and if mobile-only audits are skipped. For desktop, use `--preset=desktop` instead.                                                                                                                                                                                                                                                                                                | `string`  |             |
|               | screenEmulation                   | Sets screen emulation parameters. See also `--preset`. Use `--screenEmulation.disabled` to disable. Otherwise, set these 4 parameters individually: `--screenEmulation.mobile` `--screenEmulation.width=360` `--screenEmulation.height=640` `--screenEmulation.deviceScaleFactor=2`                                                                                                                                              |           |             |
|               | emulatedUserAgent                 | Sets useragent emulation.                                                                                                                                                                                                                                                                                                                                                                                                        | `string`  |             |
|               | max-wait-for-load                 | The timeout (in milliseconds) to wait before the page is considered done loading and the run should continue. WARNING: Very high values can lead to large traces and instability.                                                                                                                                                                                                                                                | `number`  |             |
|               | enable-error-reporting            | Enables error reporting, overriding any saved preference. `--no-enable-error-reporting` will do the opposite. More: https://github.com/GoogleChrome/lighthouse/blob/main/docs/error-reporting.md                                                                                                                                                                                                                                 | `boolean` |             |
|               | gather-mode                       | Collect artifacts from a connected browser and save to disk. (Artifacts folder path may optionally be provided). If `audit-mode` is not also enabled, the run will quit early.                                                                                                                                                                                                                                                   |           |             |
|               | audit-mode                        | Process saved artifacts from disk. (Artifacts folder path may be provided, otherwise defaults to ./latest-run/)                                                                                                                                                                                                                                                                                                                  |           |             |
|               | only-audits                       | Only run the specified audits.                                                                                                                                                                                                                                                                                                                                                                                                   | `array`   |             |
|               | only-categories                   | Only run the specified categories. Available categories: accessibility, best-practices, performance, pwa, seo.                                                                                                                                                                                                                                                                                                                   | `array`   |             |
|               | skip-audits                       | Run everything except these audits.                                                                                                                                                                                                                                                                                                                                                                                              | `array`   |             |
|               | budget-path                       | The path to the budget.json file for LightWallet.                                                                                                                                                                                                                                                                                                                                                                                | `string`  |             |
|               | disable-full-page-screenshot      | Disables collection of the full page screenshot, which can be quite large.                                                                                                                                                                                                                                                                                                                                                       | `boolean` |             |
| Output        | output                            | Reporter for the results, supports multiple values. choices: "json", "html", "csv"                                                                                                                                                                                                                                                                                                                                               | `array`   | ['html']    |
|               | output-path                       | The file path to output the results. Use 'stdout' to write to stdout. If using JSON output, default is stdout. If using HTML or CSV output, default is a file in the working directory with a name based on the test URL and date. If using multiple outputs, `--output-path` is appended with the standard extension for each output type. "reports/my-run" -> "reports/my-run.report.html", "reports/my-run.report.json", etc. | `string`  |             |
|               | view                              | Open HTML report in your browser.                                                                                                                                                                                                                                                                                                                                                                                                | `boolean` | `false`     |
| Options       | version                           | Show version `number`.                                                                                                                                                                                                                                                                                                                                                                                                           | `boolean` |             |
| Options       | cli-flags-path                    | The path to a JSON file that contains the desired CLI flags to apply. Flags specified at the command line will still override the file-based ones.                                                                                                                                                                                                                                                                               |           |             |
|               | debug-navigation                  | Pause after page load to wait for permission to continue the run, evaluate `continueLighthouseRun` in the console to continue.                                                                                                                                                                                                                                                                                                   | `boolean` |             |
|               | locale                            | The locale/language the report should be formatted in.                                                                                                                                                                                                                                                                                                                                                                           |           |             |
|               | blocked-url-patterns              | Block any network requests to the specified URL patterns.                                                                                                                                                                                                                                                                                                                                                                        | `array`   |             |
|               | disable-storage-reset             | Disable clearing the browser cache and other storage APIs before a run.                                                                                                                                                                                                                                                                                                                                                          | `boolean` |             |
|               | throttling-method                 | Controls throttling method.                                                                                                                                                                                                                                                                                                                                                                                                      | `string`  |             |
|               | throttling                        |                                                                                                                                                                                                                                                                                                                                                                                                                                  |           |             |
|               | throttling.rttMs                  | Controls simulated network RTT (TCP layer).                                                                                                                                                                                                                                                                                                                                                                                      |           |             |
|               | throttling.throughputKbps         | Controls simulated network download throughput.                                                                                                                                                                                                                                                                                                                                                                                  |           |             |
|               | throttling.requestLatencyMs       | Controls emulated network RTT (HTTP layer).                                                                                                                                                                                                                                                                                                                                                                                      |           |             |
|               | throttling.downloadThroughputKbps | Controls emulated network download throughput.                                                                                                                                                                                                                                                                                                                                                                                   |           |             |
|               | throttling.uploadThroughputKbps   | Controls emulated network upload throughput.                                                                                                                                                                                                                                                                                                                                                                                     |           |             |
|               | throttling.cpuSlowdownMultiplier  | Controls simulated + emulated CPU throttling.                                                                                                                                                                                                                                                                                                                                                                                    |           |             |
|               | extra-headers                     | Set extra HTTP Headers to pass with request.                                                                                                                                                                                                                                                                                                                                                                                     |           |             |
|               | precomputed-lantern-data-path     | Path to the file where lantern simulation data should be read from, overwriting the lantern observed estimates for RTT and server latency.                                                                                                                                                                                                                                                                                       | `string`  |             |
|               | lantern-data-output-path          | Path to the file where lantern simulation data should be written to, can be used in a future run with the `precomputed-lantern-data-path` flag.                                                                                                                                                                                                                                                                                  | `string`  |             |
|               | plugins                           | Run the specified plugins.                                                                                                                                                                                                                                                                                                                                                                                                       | `array`   |             |
|               | channel                           |                                                                                                                                                                                                                                                                                                                                                                                                                                  | `string`  | 'cli'       |
|               | chrome-ignore-default-flags       |                                                                                                                                                                                                                                                                                                                                                                                                                                  | `boolean` | `false`     |
